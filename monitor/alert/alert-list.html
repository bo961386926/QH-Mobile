<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>未处理告警 - 智慧排水运维移动端</title>
    <!-- 引入Bootstrap Icons -->
    <link rel="stylesheet" href="../../assets/libs/bootstrap-icons-1.13.1/fonts/bootstrap-icons.css">
    <!-- 引入优化后的自定义样式 -->
    <link rel="stylesheet" href="alert-styles.css">
</head>
<body>
    <!-- 引入模块化JavaScript文件 -->
    <script src="alert-data.js"></script>
    <script src="alert-filter.js"></script>
    <script src="alert-render.js"></script>
    <script src="alert-main.js"></script>
    <!-- 页面标题区域 -->
    <div class="alert-header-section">
        <div class="page-header">
            <button class="back-btn" id="backBtn">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div class="page-title">告警列表</div>
            <div class="header-placeholder"></div>
        </div>
        
        <!-- 搜索区域 -->
        <div class="search-section">
            <input type="text" id="searchInput" class="search-input" placeholder="搜索告警名称或站点名称...">
            <button class="search-btn">搜索</button>
        </div>
        
        <!-- 标签导航区域 -->
        <div class="tab-section">
            <button class="tab-btn" data-tab="all">
                全部 <span class="tab-count">6</span>
            </button>
            <button class="tab-btn" data-tab="unhandled">
                未处理 <span class="tab-count">3</span>
            </button>
            <button class="tab-btn" data-tab="processing">
                处理中 <span class="tab-count">1</span>
            </button>
            <button class="tab-btn" data-tab="handled">
                已处理 <span class="tab-count">2</span>
            </button>
        </div>
        
        <!-- 排序和筛选区域 -->
        <div class="filter-sort-section">
            <button class="sort-btn" id="sortToggle">
                <i class="bi bi-sort-down"></i>排序
            </button>
            <button class="area-btn" id="areaToggle">
                <i class="bi bi-pin-map"></i>区域
            </button>
            <button class="filter-btn" id="filterToggle">
                <i class="bi bi-funnel"></i>筛选
            </button>
        </div>
    </div>

    <div id="sortDropdown" class="sort-dropdown">
        <button class="sort-option active" data-sort="time-desc" id="sortTimeDesc">
            紧急程度优先
            <i class="bi bi-check sort-check"></i>
        </button>
        <button class="sort-option" data-sort="level-desc" id="sortLevelDesc">
            告警级别优先
            <i class="bi bi-check sort-check"></i>
        </button>
        <button class="sort-option" data-sort="time-asc" id="sortTimeAsc">
            告警时长优先
            <i class="bi bi-check sort-check"></i>
        </button>
        <button class="sort-option" data-sort="occurrence-desc" id="sortOccurrenceDesc">
            发生次数优先
            <i class="bi bi-check sort-check"></i>
        </button>
    </div>

    <div id="filter-panel" class="filter-panel" style="display: none;">
        <div class="filter-group">
            <label class="filter-label">数据时间</label>
            <div class="filter-options">
               
                <div class="filter-option active" data-time="today" id="filterTimeToday">今日</div>
                <div class="filter-option" data-time="7days" id="filterTime7Days">近7日</div>
                <div class="filter-option" data-time="30days" id="filterTime30Days">近30日</div>
                <div class="filter-option" data-time="90days" id="filterTime90Days">近90日</div>
                <!-- 将自定义时间选项替换为时间输入框 -->
                <div class="date-range-inputs">
                    <input type="date" id="customStartDate" class="date-input-small" placeholder="开始时间">
                    <span class="date-separator">至</span>
                    <input type="date" id="customEndDate" class="date-input-small" placeholder="结束时间">
            
                </div>
            </div>
        </div>
        
        <!-- 隐藏原来的日期范围选择器 -->
        <div class="date-range-picker" id="dateRangePicker" style="display: none;">
            <div class="date-inputs">
                <div class="date-input-group">
                    <label>开始时间</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <div class="date-input-group">
                    <label>结束时间</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
            </div>
            <button class="date-confirm-btn" id="applyDateRangeBtn">确定</button>
        </div>

        <div class="filter-group">
            <label class="filter-label">运维片区</label>
            <div class="filter-options">
                <div class="filter-option active" data-area="all" id="filterAreaAll">全部</div>
                <div class="filter-option" data-area="area1" id="filterArea1">一片区</div>
                <div class="filter-option" data-area="area2" id="filterArea2">二片区</div>
                <div class="filter-option" data-area="area3" id="filterArea3">三片区</div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">告警级别</label>
            <div class="filter-options">
                <div class="filter-option active" data-level="all" id="filterLevelAll">全部</div>
                <div class="filter-option" data-level="level1" id="filterLevel1">一级</div>
                <div class="filter-option" data-level="level2" id="filterLevel2">二级</div>
                <div class="filter-option" data-level="level3" id="filterLevel3">三级</div>
                <div class="filter-option" data-level="level4" id="filterLevel4">四级</div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">紧急程度</label>
            <div class="filter-options">
                <div class="filter-option active" data-urgency="all" id="filterUrgencyAll">全部</div>
                <div class="filter-option" data-urgency="critical" id="filterUrgencyCritical">紧急</div>
                <div class="filter-option" data-urgency="important" id="filterUrgencyImportant">重要</div>
                <div class="filter-option" data-urgency="normal" id="filterUrgencyNormal">普通</div>
            </div>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">告警持续时长</label>
            <div class="filter-options">
                <div class="filter-option active" data-duration="all" id="filterDurationAll">全部</div>
                <div class="filter-option" data-duration="lt1h" id="filterDurationLt1h">1小时内</div>
                <div class="filter-option" data-duration="1-3h" id="filterDuration1-3h">1-3小时</div>
                <div class="filter-option" data-duration="3-12h" id="filterDuration3-12h">3-12小时</div>
                <div class="filter-option" data-duration="12-24h" id="filterDuration12-24h">12-24小时</div>
                <div class="filter-option" data-duration="gt24h" id="filterDurationGt24h">超过24小时</div>
            </div>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">告警发生次数</label>
            <div class="range-slider-container" data-value="100">
                <input type="range" min="1" max="100" value="100" class="range-slider" id="occurrenceRangeSlider">
                <span class="range-value" id="occurrenceRangeValue">1-100次</span>
            </div>
        </div>

        <div class="filter-actions">
            <button class="filter-reset-btn" id="resetFiltersBtn">重置</button>
            <button class="filter-apply-btn" id="applyFiltersBtn">确定</button>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <!-- 区域选择面板 -->
    <div id="areaSelector" class="area-selector-panel">
        <div class="area-panel-header">
            <div class="area-panel-title">选择区域</div>
            <button class="area-panel-close" id="closeAreaSelectorBtn">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="area-selector">
            <div class="area-column">
                <div class="area-option active" data-level="0" data-value="all" id="areaAll">
                    <span class="area-option-text">全部区域</span>
                </div>
                <div class="area-option" data-level="0" data-value="lanxi" id="areaLanxi">
                    <span class="area-option-text">兰溪市</span>
                    <i class="bi bi-chevron-right area-option-arrow"></i>
                </div>
            </div>
            <div class="area-column" id="areaColumn1">
                <!-- 动态加载的子区域将在这里显示 -->
            </div>
        </div>
    </div>

    <!-- 告警列表容器 -->
    <div class="main-content">
        <div class="card-container">
            <div class="card-body" id="alertListContainer">
                <div id="alertList">
                    <!-- 告警列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

  
    <!-- 提示信息容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // 页面跳转函数
        function onAlertTitleClick(alertId) {
            // 这里应该跳转到告警详情页，但不硬编码URL
            console.log('点击告警标题，跳转到告警详情页，ID:', alertId);
            // 实际应用中应该使用：window.location.href = 'alert-detail.html?id=' + alertId;
        }
        
        function onStationNameClick(stationName) {
            // 这里应该跳转到站点详情页，但不硬编码URL
            console.log('点击站点名称，跳转到站点详情页，名称:', stationName);
            // 实际应用中应该使用：window.location.href = '../station-perspective.html?station=' + stationName;
        }

        // 返回监控页面
        function goBackToMonitor() {
            window.location.href = '../monitor.html';
        }

        // 添加返回按钮事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    // 返回到监控主页面
                    window.location.href = '../monitor.html';
                });
            }
        });

        // 说明：初始化与事件监听已在 alert-main.js 中统一处理，这里不再重复绑定，避免双触发

        // 设置事件监听器
        function setupEventListeners() {
            // 返回按钮事件
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', goBackToMonitor);
            }
            
            // 搜索输入框事件
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.searchAlerts(e.target.value);
                    }
                });
            }

            // 搜索按钮事件
            const searchBtn = document.querySelector('.search-btn');
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined' && searchInput) {
                        AlertListModule.searchAlerts(searchInput.value);
                    }
                });
            }

            // 标签页切换事件
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.switchTab(tab);
                    }
                    
                    // 更新标签页激活状态
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // 注意：筛选/排序/区域的点击事件已在 alert-main.js 绑定，这里不再重复绑定

            // 筛选重置事件
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.resetFilters();
                    }
                });
            }

            // 筛选应用事件
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.applyFilters();
                    }
                });
            }

            // 区域选择面板关闭事件
            const closeAreaSelectorBtn = document.getElementById('closeAreaSelectorBtn');
            if (closeAreaSelectorBtn) {
                closeAreaSelectorBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.closeAreaSelector();
                    }
                });
            }

            // 模态框关闭事件
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.closeModal();
                    }
                });
            }

            const closeModalBtn2 = document.getElementById('closeModalBtn2');
            if (closeModalBtn2) {
                closeModalBtn2.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.closeModal();
                    }
                });
            }

            // 处理告警事件
            const handleAlertBtn = document.getElementById('handleAlertBtn');
            if (handleAlertBtn) {
                handleAlertBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.handleAlert();
                    }
                });
            }

            // 遮罩层点击事件在 alert-main.js 内已处理

            // 排序选项点击事件
            const sortOptions = document.querySelectorAll('.sort-option');
            sortOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const sortType = this.getAttribute('data-sort');
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.sortAlerts(sortType);
                    }
                    
                    // 更新排序选项激活状态
                    sortOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // 筛选选项点击事件
            setupFilterOptionListeners('filterTimeAll', 'time', 'all');
            setupFilterOptionListeners('filterTimeToday', 'time', 'today');
            setupFilterOptionListeners('filterTime7Days', 'time', '7days');
            setupFilterOptionListeners('filterTime30Days', 'time', '30days');
            setupFilterOptionListeners('filterTime90Days', 'time', '90days');
            setupFilterOptionListeners('filterTimeCustom', 'time', 'custom');
            
            setupFilterOptionListeners('filterAreaAll', 'area', 'all');
            setupFilterOptionListeners('filterArea1', 'area', 'area1');
            setupFilterOptionListeners('filterArea2', 'area', 'area2');
            setupFilterOptionListeners('filterArea3', 'area', 'area3');
            
            setupFilterOptionListeners('filterLevelAll', 'level', 'all');
            setupFilterOptionListeners('filterLevel1', 'level', 'level1');
            setupFilterOptionListeners('filterLevel2', 'level', 'level2');
            setupFilterOptionListeners('filterLevel3', 'level', 'level3');
            setupFilterOptionListeners('filterLevel4', 'level', 'level4');
            
            setupFilterOptionListeners('filterUrgencyAll', 'urgency', 'all');
            setupFilterOptionListeners('filterUrgencyCritical', 'urgency', 'critical');
            setupFilterOptionListeners('filterUrgencyImportant', 'urgency', 'important');
            setupFilterOptionListeners('filterUrgencyNormal', 'urgency', 'normal');
            
            setupFilterOptionListeners('filterDurationAll', 'duration', 'all');
            setupFilterOptionListeners('filterDurationLt1h', 'duration', 'lt1h');
            setupFilterOptionListeners('filterDuration1-3h', 'duration', '1-3h');
            setupFilterOptionListeners('filterDuration3-12h', 'duration', '3-12h');
            setupFilterOptionListeners('filterDuration12-24h', 'duration', '12-24h');
            setupFilterOptionListeners('filterDurationGt24h', 'duration', 'gt24h');
            
            setupFilterOptionListeners('filterOccurrenceAll', 'occurrence', 'all');
            setupFilterOptionListeners('filterOccurrence1-5', 'occurrence', '1-5');
            setupFilterOptionListeners('filterOccurrence6-20', 'occurrence', '6-20');
            setupFilterOptionListeners('filterOccurrence21-50', 'occurrence', '21-50');
            setupFilterOptionListeners('filterOccurrenceGt50', 'occurrence', 'gt50');
            
            setupFilterOptionListeners('filterStatusAll', 'status', 'all');
            setupFilterOptionListeners('filterStatusActive', 'status', 'active');
            setupFilterOptionListeners('filterStatusResolved', 'status', 'resolved');
            setupFilterOptionListeners('filterStatusAcknowledged', 'status', 'acknowledged');

            // 自定义时间筛选显示事件
            const filterTimeCustom = document.getElementById('filterTimeCustom');
            if (filterTimeCustom) {
                filterTimeCustom.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.showDateRangePicker();
                    }
                });
            }

            // 日期范围滑块事件
            const occurrenceRangeSlider = document.getElementById('occurrenceRangeSlider');
            if (occurrenceRangeSlider) {
                occurrenceRangeSlider.addEventListener('input', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.updateOccurrenceRange(this.value);
                    }
                });
            }

            // 区域选择事件
            const areaLanxi = document.getElementById('areaLanxi');
            if (areaLanxi) {
                areaLanxi.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        // AlertListModule.selectArea(this, 'lanxi');
                        populateAreaChildren('lanxi');
                    }
                });
            }
            
            // 全部区域选择事件
            const areaAll = document.getElementById('areaAll');
            if (areaAll) {
                areaAll.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.selectArea(this, 'all');
                        AlertListModule.closeAreaSelector();
                    }
                });
            }

            // 筛选选项事件监听器设置函数
            function setupFilterOptionListeners(elementId, filterType, filterValue) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener('click', function() {
                        if (typeof AlertListModule !== 'undefined') {
                            AlertListModule.selectFilterOption(this, filterType, filterValue);
                        }
                    });
                }
            }
            
            // 自定义日期范围应用按钮事件
            const applyCustomDateBtn = document.getElementById('applyCustomDateBtn');
            if (applyCustomDateBtn) {
                applyCustomDateBtn.addEventListener('click', function() {
                    if (typeof AlertListModule !== 'undefined') {
                        AlertListModule.applyCustomDateRange();
                    }
                });
            }
        }
    </script>